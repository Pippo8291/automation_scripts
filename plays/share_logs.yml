---

- name: "Sharing debug logs"
  become: no
  hosts: buildserver
  gather_facts: false
      
  tasks:
    
    - name: gather needed facts
      ansible.builtin.setup:

    - include_role:
        name: common
        tasks_from: justvault.yml
        public: yes

    - name: moo
      debug:
        msg: "{{ ansible_config_file }}"

    - name: get cfg
      ansible.builtin.ini:
        option: log_path
        section: defaults
        path: "{{ ansible_config_file }}"
      register: cfg

    - fail:
        msg: "booooo: {{ cfg }}"
        
    - name: paste ansible log
      connection: local
      shell: >-
        gist-paste --private  -d "ANSIBLE LOG - {{ ansible_facts['date_time']['iso8601'] }}" -f ansible.log.{{ ansible_facts['date_time']['iso8601'] }}.yaml  {{ lookup('ansible.builtin.ini', 'log_path', section='defaults',  file=ansible_config_file) }}
      register: paste_ansible
      when: skip_fetch_ansible_log is undefined or skip_fetch_ansible_log

    - name: Fetch build log
      fetch:
        src: "build_{{ target_model }}_{{ android_shortversion }}_{{ ROM_FLAVOR }}.log"
        dest: /tmp/
      when: skip_fetch_build_log is undefined or skip_fetch_build_log

    - name: paste build log
      connection: local
      shell: >-
        gist-paste --private  -d "BUILD LOG - {{ ansible_facts['date_time']['iso8601'] }}" -f build.log.{{ ansible_facts['date_time']['iso8601'] }}.sh /tmp/{{ inventory_hostname }}/build_{{ target_model }}_{{ android_shortversion }}_{{ ROM_FLAVOR }}.log
      register: paste_build
      when: skip_fetch_build_log is undefined or skip_fetch_build_log

    - name: "Print generated links"
      connection: local
      debug:
        msg: |
          Please share the following links:
          
          - ansible: {{ paste_ansible.stdout | d('empty') }}
          - build: {{ paste_build.stdout | d('empty') }}
    
    - name: "Telegram notify"
      connection: local
      community.general.telegram:
        token: "{{ vault_tg_token }}"
        api_args:
          chat_id: "{{ vault_tg_group_id_failing }}"
          parse_mode: "MarkdownV2"
          text: |
            Debug logs uploaded:
          
            \- ansible: [log]({{ paste_ansible.stdout | d('empty') }})
            \- build: [log]({{ paste_build.stdout | d('empty') }})
          disable_web_page_preview: True
      when: telegram_notifications | bool
