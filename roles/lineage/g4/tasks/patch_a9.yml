---

- name: "PIE: applying misc patches"
  shell: "source build/envsetup.sh > /dev/null && echo 'applying misc patch:' && {{ item }}"
  args:
    executable: /bin/bash
    chdir: "{{ SRCPATH }}"
  loop:
    - "repopick -f 307334/2 -P frameworks/base/"                      # scale font patch
    - "git apply external/patches/frameworks_base_shadercache.patch"  # always use shader cache

- set_fact:
    SECPATCH_DATE: "2023-01"

- name: "PIE: applying security patches up to: {{ SECPATCH_DATE }}-05"
  shell: "source build/envsetup.sh > /dev/null && echo 'applying {{ item }}:' && repopick -f -t {{ item }}"
  args:
    executable: /bin/bash
    chdir: "{{ SRCPATH }}"
  loop:
    #- "P_asb_2022-02" # merged officially!
    #- "P_asb_2022-03" # merged officially!
    #- "P_asb_2022-04" # merged officially!
    - "P_asb_2022-05"
    - "P_asb_2022-06"
    - "P_asb_2022-07"
    - "P_asb_2022-08"
    - "P_asb_2022-09"
    - "P_asb_2022-10"
    - "P_asb_2022-11"
    - "P_asb_2022-12"
    - "P_asb_{{ SECPATCH_DATE }}"
    
- name: "PIE: bump security patch version string to: {{ SECPATCH_DATE }}-05"
  lineinfile:
    path: "{{ SRCPATH }}/build/core/version_defaults.mk"
    regexp: "PLATFORM_SECURITY_PATCH := .*"
    line: "PLATFORM_SECURITY_PATCH := {{ SECPATCH_DATE }}-05"
