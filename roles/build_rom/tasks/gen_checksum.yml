---

- set_fact:
    LOCFILE: "{{ PREFIXFNAME }}.*-{{ RELEASE_TYPE }}.*\\.zip"
  when:
    - ROM_FLAVOR != "TWRP"

- set_fact:
    LOCFILE: "{{ PREFIXFNAME }}.*-{{ RELEASE_TYPE }}.*\\.img"
  when:
    - ROM_FLAVOR == "TWRP"

- name: "Get current build filename"
  shell: "find ./ -maxdepth 2 -regex '.*/{{ LOCFILE }}' | tr -d '\\n' | sed 's#^\\./##g'"
  args:
    chdir: "{{ JKZIPDIR }}"
  register: ROMFILE

- name: "Generate hash for {{ ROMFILE.stdout }}"
  stat:
    path: "{{ JKZIPDIR }}/{{ ROMFILE.stdout }}"
    checksum_algorithm: sha256
  register: hash

- name: "Write hash {{ ROMFILE.stdout }}.sha256sum"
  shell: "echo '{{ hash.stat.checksum }}    {{ ROMFILE.stdout }}' > {{ ROMFILE.stdout }}.sha256sum"
  args:
    chdir: "{{ JKZIPDIR }}"

- name: "Copy build.prop for OTA"
  shell: "cp -vf {{ SRCPATH }}/out/target/product/*/system/build.prop {{ JKZIPDIR }}/{{ ROMFILE.stdout }}.prop"
  when:
    - ROM_FLAVOR != "TWRP"
    - ROM_FLAVOR != "SHRP"
